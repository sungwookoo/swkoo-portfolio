name: Build and Push Containers

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  REGISTRY_HOST: ${{ secrets.OCI_REGISTRY_HOST }} # 예: icn.ocir.io
  NAMESPACE: ${{ secrets.OCI_TENANCY_NAMESPACE }}
  BACKEND_REPO: ${{ secrets.OCI_BACKEND_REPO }} # 예: swkoo-backend
  FRONTEND_REPO: ${{ secrets.OCI_FRONTEND_REPO }} # 예: swkoo-frontend
  BACKEND_TAG_PREFIX: backend
  FRONTEND_TAG_PREFIX: frontend

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - uses: actions/checkout@v4

      - name: Log in to OCI registry
        env:
          OCI_USERNAME: ${{ secrets.OCI_USERNAME }}
          OCI_AUTH_TOKEN: ${{ secrets.OCI_AUTH_TOKEN }}
        run: |
          if [ -z "$REGISTRY_HOST" ]; then
            echo "REGISTRY_HOST secret is required" >&2
            exit 1
          fi
          echo "$OCI_AUTH_TOKEN" | docker login "${REGISTRY_HOST}" --username "$OCI_USERNAME" --password-stdin

      - name: Build backend image
        run: |
          export PATH="/usr/local/bin:$PATH"
          SHA_TAG="${BACKEND_TAG_PREFIX}-${GITHUB_SHA}"
          LATEST_TAG="${BACKEND_TAG_PREFIX}-latest"
          ./scripts/build-backend.sh "${REGISTRY_HOST}/${NAMESPACE}/${BACKEND_REPO}:${SHA_TAG}"
          docker tag "${REGISTRY_HOST}/${NAMESPACE}/${BACKEND_REPO}:${SHA_TAG}" "${REGISTRY_HOST}/${NAMESPACE}/${BACKEND_REPO}:${LATEST_TAG}"

      - name: Build frontend image
        run: |
          export PATH="/usr/local/bin:$PATH"
          SHA_TAG="${FRONTEND_TAG_PREFIX}-${GITHUB_SHA}"
          LATEST_TAG="${FRONTEND_TAG_PREFIX}-latest"
          ./scripts/build-frontend.sh "${REGISTRY_HOST}/${NAMESPACE}/${FRONTEND_REPO}:${SHA_TAG}"
          docker tag "${REGISTRY_HOST}/${NAMESPACE}/${FRONTEND_REPO}:${SHA_TAG}" "${REGISTRY_HOST}/${NAMESPACE}/${FRONTEND_REPO}:${LATEST_TAG}"

      - name: Push backend image
        run: |
          SHA_TAG="${BACKEND_TAG_PREFIX}-${GITHUB_SHA}"
          LATEST_TAG="${BACKEND_TAG_PREFIX}-latest"
          docker push "${REGISTRY_HOST}/${NAMESPACE}/${BACKEND_REPO}:${SHA_TAG}"
          docker push "${REGISTRY_HOST}/${NAMESPACE}/${BACKEND_REPO}:${LATEST_TAG}"

      - name: Push frontend image
        run: |
          SHA_TAG="${FRONTEND_TAG_PREFIX}-${GITHUB_SHA}"
          LATEST_TAG="${FRONTEND_TAG_PREFIX}-latest"
          docker push "${REGISTRY_HOST}/${NAMESPACE}/${FRONTEND_REPO}:${SHA_TAG}"
          docker push "${REGISTRY_HOST}/${NAMESPACE}/${FRONTEND_REPO}:${LATEST_TAG}"
