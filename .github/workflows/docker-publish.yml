name: Build and Push Containers

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  REGISTRY_HOST: ${{ secrets.OCI_REGISTRY_HOST }}
  NAMESPACE: ${{ secrets.OCI_TENANCY_NAMESPACE }}
  BACKEND_REPO: ${{ secrets.OCI_BACKEND_REPO }}
  FRONTEND_REPO: ${{ secrets.OCI_FRONTEND_REPO }}

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to OCI registry
        env:
          OCI_USERNAME: ${{ secrets.OCI_USERNAME }}
          OCI_AUTH_TOKEN: ${{ secrets.OCI_AUTH_TOKEN }}
        run: |
          if [ -z "$REGISTRY_HOST" ]; then
            echo "REGISTRY_HOST secret is required" >&2
            exit 1
          fi
          echo "$OCI_AUTH_TOKEN" | docker login "${REGISTRY_HOST}" --username "$OCI_USERNAME" --password-stdin

      - name: Build and push backend image
        run: |
          SHA_TAG="${GITHUB_SHA}"
          docker buildx build \
            --platform linux/amd64,linux/arm64 \
            --file apps/backend/Dockerfile \
            --tag "${REGISTRY_HOST}/${NAMESPACE}/${BACKEND_REPO}:${SHA_TAG}" \
            --tag "${REGISTRY_HOST}/${NAMESPACE}/${BACKEND_REPO}:latest" \
            --push \
            apps/backend

      - name: Build and push frontend image
        run: |
          SHA_TAG="${GITHUB_SHA}"
          docker buildx build \
            --platform linux/amd64,linux/arm64 \
            --file apps/frontend/Dockerfile \
            --tag "${REGISTRY_HOST}/${NAMESPACE}/${FRONTEND_REPO}:${SHA_TAG}" \
            --tag "${REGISTRY_HOST}/${NAMESPACE}/${FRONTEND_REPO}:latest" \
            --push \
            apps/frontend
